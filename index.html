<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>غرفة الدردشة</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="loginScreen">
    <h2>دخول الغرفة</h2>
    <input type="text" id="usernameInput" placeholder="اسم المستخدم">
    <input type="password" id="passwordInput" placeholder="مفتاح الغرفة">
    <button id="enterRoomBtn" disabled>دخول</button>
</div>

<div id="chatScreen" class="hidden">
    <h2>غرفة الدردشة: <span id="roomKeyDisplay"></span></h2>
    <div id="messagesContainer"></div>
    <textarea id="messageInput" placeholder="اكتب رسالتك..."></textarea>
    <button id="sendMessageBtn">إرسال</button>
    <button id="sendImageBtn">صورة</button>
    <button id="leaveRoomBtn">الخروج</button>
    <div>
        <button id="addTimeBtn">تمديد 5 دقائق</button>
        <button id="doubleTimeBtn">مضاعفة الوقت</button>
    </div>
</div>

<div id="expiredScreen" class="hidden">
    <h2>انتهت مدة الغرفة</h2>
    <button id="newRoomBtn">إنشاء غرفة جديدة</button>
</div>

<input type="file" id="imageMessageInput" accept="image/*" class="hidden">
<input type="file" id="customImageInput" accept="image/*" class="hidden">

<script>
let currentUser = null;
let currentRoomKey = null;
let isRoomOwner = false;
let pendingUsers = [];
let messages = [];
let countdownInterval = null;
let roomTime = 15 * 60; // 15 دقيقة افتراضية
const maxRoomTime = 60 * 60; // ساعة كحد أقصى

const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const enterRoomBtn = document.getElementById('enterRoomBtn');
const chatScreen = document.getElementById('chatScreen');
const loginScreen = document.getElementById('loginScreen');
const expiredScreen = document.getElementById('expiredScreen');
const roomKeyDisplay = document.getElementById('roomKeyDisplay');
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const leaveRoomBtn = document.getElementById('leaveRoomBtn');
const addTimeBtn = document.getElementById('addTimeBtn');
const doubleTimeBtn = document.getElementById('doubleTimeBtn');
const sendImageBtn = document.getElementById('sendImageBtn');
const imageMessageInput = document.getElementById('imageMessageInput');
const customImageInput = document.getElementById('customImageInput');

// تفعيل زر الدخول عند إدخال الاسم والمفتاح
function updateEnterButton() {
    enterRoomBtn.disabled = !usernameInput.value || !passwordInput.value;
}

function enterRoom() {
    const username = usernameInput.value.trim();
    const password = passwordInput.value.trim();

    if (!username || !password) return;

    currentUser = username;
    currentRoomKey = password;

    // تحقق إذا كان المستخدم أول مرة يدخل الغرفة => يصبح مالك الغرفة
    const roomOwnerKey = localStorage.getItem('roomOwner_' + currentRoomKey);
    if (!roomOwnerKey) {
        isRoomOwner = true;
        localStorage.setItem('roomOwner_' + currentRoomKey, currentUser);
    } else if (roomOwnerKey !== currentUser) {
        // المستخدم ليس المالك
        isRoomOwner = false;
        pendingUsers.push(currentUser);
        showCustomAlert('انتظر موافقة مدير الغرفة للدخول');
        return;
    } else {
        isRoomOwner = true;
    }

    // عرض الدردشة
    loginScreen.classList.add('hidden');
    chatScreen.classList.remove('hidden');
    roomKeyDisplay.textContent = currentRoomKey;

    loadMessages();
    startCountdown();
}

function loadMessages() {
    messagesContainer.innerHTML = '';
    messages.forEach(addMessage);
}

function addMessage(msg) {
    const div = document.createElement('div');
    div.className = `message ${msg.sender}`;
    if (msg.type === 'text') div.textContent = msg.text;
    if (msg.type === 'image') {
        const img = document.createElement('img');
        img.src = msg.imageUrl;
        img.className = 'chat-image';
        div.appendChild(img);
    }
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// عداد الوقت
function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        roomTime--;
        if (roomTime <= 0) {
            clearInterval(countdownInterval);
            chatScreen.classList.add('hidden');
            expiredScreen.classList.remove('hidden');
        }
    }, 1000);
}

function addTime() {
    roomTime = Math.min(roomTime + 5 * 60, maxRoomTime);
}

function doubleTime() {
    roomTime = Math.min(roomTime * 2, maxRoomTime);
}

function showCustomAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
            <div class="text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <p class="mb-4">${message}</p>
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                    حسناً
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

passwordInput.addEventListener('input', updateEnterButton);
usernameInput.addEventListener('input', updateEnterButton);
enterRoomBtn.addEventListener('click', enterRoom);
leaveRoomBtn.addEventListener('click', () => {
    if (countdownInterval) clearInterval(countdownInterval);
    chatScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    currentUser = null;
    currentRoomKey = null;
    isRoomOwner = false;
    pendingUsers = [];
});
</script>
</body>
</html>
<script>
// إرسال صورة
function handleImageSend(file) {
    if (!file || !file.type.startsWith('image/')) {
        showCustomAlert('يرجى اختيار ملف صورة صحيح');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const message = {
            id: Date.now(),
            imageUrl: e.target.result,
            timestamp: new Date(),
            type: 'image',
            sender: 'user',
            username: currentUser
        };
        
        addMessage(message);
        messages.push(message);
    };
    reader.readAsDataURL(file);
}

// رفع صورة مخصصة
function handleCustomImage(file) {
    if (!file || !file.type.startsWith('image/')) {
        showCustomAlert('يرجى اختيار ملف صورة صحيح');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const customImage = {
            url: e.target.result,
            name: 'صورة مخصصة',
            id: 'custom_' + Date.now()
        };
        
        const imageDiv = document.createElement('div');
        imageDiv.className = `image-hover cursor-pointer rounded-lg overflow-hidden border-2 border-transparent 
                             hover:border-primary transition-all aspect-square relative bg-gray-100`;
        imageDiv.innerHTML = `
            <img src="${customImage.url}" alt="${customImage.name}" 
                 class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all 
                        flex items-center justify-center">
                <span class="text-white text-xs font-bold opacity-0 hover:opacity-100 transition-opacity
                           bg-black bg-opacity-50 px-2 py-1 rounded">
                    ${customImage.name}
                </span>
            </div>
            <div class="absolute top-1 right-1 bg-primary text-white text-xs px-2 py-1 rounded">
                مخصصة
            </div>
        `;
        
        imageDiv.addEventListener('click', () => selectImage(customImage, imageDiv));
        document.body.appendChild(imageDiv);
        selectImage(customImage, imageDiv);
    };
    reader.readAsDataURL(file);
}

// عرض الصورة في نافذة منبثقة
function showImageModal(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${imageUrl}" alt="صورة مكبرة" class="max-w-full max-h-full object-contain rounded-lg">
            <button onclick="this.closest('.fixed').remove()" 
                    class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-10 h-10 
                           flex items-center justify-center hover:bg-opacity-75 transition-colors">
                ✕
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// اختيار صورة مخصصة
function selectImage(image, imageDiv) {
    const message = {
        id: Date.now(),
        imageUrl: image.url,
        timestamp: new Date(),
        type: 'image',
        sender: 'user',
        username: currentUser
    };
    addMessage(message);
    messages.push(message);
}

// مستمعي أحداث الصور
sendImageBtn.addEventListener('click', () => {
    imageMessageInput.click();
});

imageMessageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleImageSend(file);
});

document.getElementById('uploadImageBtn')?.addEventListener('click', () => {
    customImageInput.click();
});

customImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleCustomImage(file);
});
</script>
<script>
// إعادة تعيين النموذج
function resetForm() {
    selectedImage = null;
    passwordInput.value = '';
    messageInput.value = '';
    messages = [];
    currentRoomKey = null;
    currentUser = null;
    
    document.querySelectorAll('.border-primary').forEach(el => {
        el.classList.remove('border-primary');
        el.classList.add('border-transparent');
    });
    
    updateEnterButton();
}

// إرسال رسالة نصية
function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    const message = {
        id: Date.now(),
        text: escapeHtml(text),
        timestamp: new Date(),
        type: 'text',
        sender: 'user',
        username: currentUser
    };
    
    addMessage(message);
    messages.push(message);
    messageInput.value = '';
    messageInput.style.height = 'auto';
}

// دالة مساعدة لتجنب XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// عرض تنبيه مخصص
function showCustomAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-6">
            <div class="text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                    حسناً
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// تغيير حجم مربع النص تلقائياً
messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = messageInput.scrollHeight + 'px';
});

// مستمعين أحداث
sendMessageBtn.addEventListener('click', sendMessage);

messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// مغادرة الغرفة
leaveRoomBtn.addEventListener('click', () => {
    if (countdownInterval) clearInterval(countdownInterval);
    
    if (currentRoomKey && currentUser) {
        const leaveMessage = {
            id: Date.now(),
            text: `${currentUser} غادر المحادثة`,
            timestamp: new Date(),
            type: 'text',
            sender: 'system'
        };
        addMessage(leaveMessage);
    }
    
    chatScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    resetForm();
});

// إنشاء غرفة جديدة
newRoomBtn.addEventListener('click', () => {
    expiredScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
    resetForm();
});

// تهيئة التطبيق
document.addEventListener('DOMContentLoaded', () => {
    loadImageGallery();
    setupDurationSelection();
    updateEnterButton();
});
</script>
