<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>غرفة الدردشة المشتركة</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<!-- شاشة الدخول -->
<div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen p-4">
    <h1 class="text-2xl font-bold mb-4">أدخل الغرفة</h1>
    <input type="text" id="usernameInput" placeholder="اسمك" class="mb-2 p-2 border rounded w-full max-w-sm">
    <input type="text" id="passwordInput" placeholder="مفتاح الغرفة" class="mb-4 p-2 border rounded w-full max-w-sm">
    <button id="enterRoomBtn" class="bg-primary text-white px-6 py-2 rounded w-full max-w-sm">دخول</button>
</div>

<!-- شاشة الدردشة -->
<div id="chatScreen" class="hidden flex flex-col min-h-screen">
    <div class="flex justify-between items-center p-4 bg-gray-200 dark:bg-gray-800">
        <div id="roomInfo">غرفة: <span id="roomKeyDisplay"></span></div>
        <div>
            <button id="leaveRoomBtn" class="bg-red-500 text-white px-3 py-1 rounded">مغادرة</button>
            <button id="addTimeBtn" class="bg-green-500 text-white px-3 py-1 rounded">إضافة 5 دقائق</button>
            <button id="doubleTimeBtn" class="bg-blue-500 text-white px-3 py-1 rounded">مضاعفة الوقت</button>
        </div>
    </div>

    <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto bg-white dark:bg-gray-800">
        <!-- الرسائل تظهر هنا -->
    </div>

    <div class="p-4 bg-gray-100 dark:bg-gray-900 flex flex-col">
        <textarea id="messageInput" placeholder="اكتب رسالتك..." class="w-full p-2 rounded mb-2 resize-none"></textarea>
        <div class="flex justify-between items-center">
            <div>
                <button id="sendMessageBtn" class="bg-primary text-white px-4 py-2 rounded">إرسال</button>
                <button id="sendImageBtn" class="bg-gray-500 text-white px-4 py-2 rounded">إرسال صورة</button>
                <input type="file" id="imageMessageInput" class="hidden">
            </div>
            <div>
                <button id="uploadImageBtn" class="bg-purple-500 text-white px-4 py-2 rounded">رفع صورة مخصصة</button>
                <input type="file" id="customImageInput" class="hidden">
            </div>
        </div>
    </div>

    <!-- معرض الصور -->
    <div id="imageGallery" class="flex p-4 gap-4 overflow-x-auto bg-gray-50 dark:bg-gray-700"></div>
</div>
<script>
let messages = [];
let selectedImage = null;
let countdownInterval = null;
let roomDuration = 300; // 5 دقائق
let maxDuration = 3600; // أقصى ساعة
let currentRoomKey = null;
let currentUser = null;
let roomManager = null;
let pendingUsers = [];

const loginScreen = document.getElementById('loginScreen');
const chatScreen = document.getElementById('chatScreen');
const usernameInput = document.getElementById('usernameInput');
const passwordInput = document.getElementById('passwordInput');
const enterRoomBtn = document.getElementById('enterRoomBtn');
const leaveRoomBtn = document.getElementById('leaveRoomBtn');
const messagesContainer = document.getElementById('messagesContainer');
const messageInput = document.getElementById('messageInput');
const sendMessageBtn = document.getElementById('sendMessageBtn');
const sendImageBtn = document.getElementById('sendImageBtn');
const imageMessageInput = document.getElementById('imageMessageInput');
const uploadImageBtn = document.getElementById('uploadImageBtn');
const customImageInput = document.getElementById('customImageInput');
const imageGallery = document.getElementById('imageGallery');
const addTimeBtn = document.getElementById('addTimeBtn');
const doubleTimeBtn = document.getElementById('doubleTimeBtn');
const roomKeyDisplay = document.getElementById('roomKeyDisplay');

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showCustomAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-sm w-full p-6">
            <div class="text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                <button onclick="this.closest('.fixed').remove()" 
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-2 rounded-lg transition-colors">
                    حسناً
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
function addMessage(message) {
    messages.push(message);
    const div = document.createElement('div');
    div.className = message.sender === 'user' ? 'mb-2 text-right' : 'mb-2 text-left';
    
    if (message.type === 'text') {
        div.innerHTML = `<span class="inline-block px-3 py-2 rounded-lg ${message.sender === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-white'}">${escapeHtml(message.text)}</span>`;
    } else if (message.type === 'image') {
        div.innerHTML = `<img src="${message.imageUrl}" class="max-w-xs rounded-lg cursor-pointer" onclick="showImageModal('${message.imageUrl}')">`;
    }

    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function handleImageSend(file) {
    if (!file || !file.type.startsWith('image/')) {
        showCustomAlert('يرجى اختيار ملف صورة صحيح');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        const message = {
            id: Date.now(),
            imageUrl: e.target.result,
            timestamp: new Date(),
            type: 'image',
            sender: 'user',
            username: currentUser
        };
        addMessage(message);
    };
    reader.readAsDataURL(file);
}

function handleCustomImage(file) {
    if (!file || !file.type.startsWith('image/')) {
        showCustomAlert('يرجى اختيار ملف صورة صحيح');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        const customImage = {
            url: e.target.result,
            name: 'صورة مخصصة',
            id: 'custom_' + Date.now()
        };
        const imageDiv = document.createElement('div');
        imageDiv.className = `image-hover cursor-pointer rounded-lg overflow-hidden border-2 border-transparent hover:border-primary transition-all aspect-square relative bg-gray-100`;
        imageDiv.innerHTML = `
            <img src="${customImage.url}" alt="${customImage.name}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-30 transition-all flex items-center justify-center">
                <span class="text-white text-xs font-bold opacity-0 hover:opacity-100 transition-opacity bg-black bg-opacity-50 px-2 py-1 rounded">${customImage.name}</span>
            </div>
            <div class="absolute top-1 right-1 bg-primary text-white text-xs px-2 py-1 rounded">مخصصة</div>
        `;
        imageDiv.addEventListener('click', () => selectImage(customImage, imageDiv));
        imageGallery.insertBefore(imageDiv, imageGallery.firstChild);
        selectImage(customImage, imageDiv);
    };
    reader.readAsDataURL(file);
}

function showImageModal(imageUrl) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="relative max-w-4xl max-h-full">
            <img src="${imageUrl}" alt="صورة مكبرة" class="max-w-full max-h-full object-contain rounded-lg">
            <button onclick="this.closest('.fixed').remove()" 
                    class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75 transition-colors">
                ✕
            </button>
        </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click', (e) => { if(e.target===modal) modal.remove(); });
}
function enterRoom() {
    const username = usernameInput.value.trim();
    const roomKey = passwordInput.value.trim();

    if (!username || !roomKey) { showCustomAlert('يرجى إدخال الاسم والمفتاح'); return; }

    currentUser = username;
    currentRoomKey = roomKey;
    roomKeyDisplay.textContent = roomKey;

    if (!roomManager) {
        roomManager = currentUser;
        chatScreen.classList.remove('hidden');
        loginScreen.classList.add('hidden');
        addSystemMessage(`${currentUser} أصبح مدير الغرفة`);
    } else if (roomManager !== currentUser) {
        pendingUsers.push(currentUser);
        addSystemMessage(`${currentUser} طلب الدخول للغرفة`);
        showCustomAlert(`يرجى انتظار موافقة المدير (${roomManager})`);
        currentUser = null; 
        return;
    }

    startCountdown();
}

function addSystemMessage(text) {
    addMessage({ id: Date.now(), text, type: 'text', sender: 'system' });
}

function startCountdown() {
    if (countdownInterval) clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        roomDuration--;
        if (roomDuration <= 0) {
            clearInterval(countdownInterval);
            addSystemMessage('انتهى وقت الغرفة');
            chatScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }
    }, 1000);
}

function addTime() {
    roomDuration = Math.min(roomDuration + 300, maxDuration); // إضافة 5 دقائق
}

function doubleTime() {
    roomDuration = Math.min(roomDuration * 2, maxDuration);
}
function resetForm() {
    selectedImage = null;
    messageInput.value = '';
    messages = [];
    currentRoomKey = null;
    currentUser = null;
    pendingUsers = [];
    roomManager = null;
    roomDuration = 300;
    clearInterval(countdownInterval);
    countdownInterval = null;

    document.querySelectorAll('.border-primary').forEach(el => {
        el.classList.remove('border-primary');
        el.classList.add('border-transparent');
    });
}

sendMessageBtn.addEventListener('click
sendMessageBtn.addEventListener('click', () => {
    const text = messageInput.value.trim();
    if (!text) return;
    addMessage({ id: Date.now(), text, type: 'text', sender: 'user', username: currentUser });
    messageInput.value = '';
});

sendImageBtn.addEventListener('click', () => imageMessageInput.click());

imageMessageInput.addEventListener('change', (e) => {
    handleImageSend(e.target.files[0]);
    e.target.value = '';
});

uploadImageBtn.addEventListener('click', () => customImageInput.click());

customImageInput.addEventListener('change', (e) => {
    handleCustomImage(e.target.files[0]);
    e.target.value = '';
});

addTimeBtn.addEventListener('click', addTime);
doubleTimeBtn.addEventListener('click', doubleTime);

leaveRoomBtn.addEventListener('click', () => {
    resetForm();
    chatScreen.classList.add('hidden');
    loginScreen.classList.remove('hidden');
});

enterRoomBtn.addEventListener('click', enterRoom);

function selectImage(image, div) {
    document.querySelectorAll('#imageGallery .image-hover').forEach(el => {
        el.classList.remove('border-primary');
        el.classList.add('border-transparent');
    });
    div.classList.add('border-primary');
    selectedImage = image;
}
</script>
